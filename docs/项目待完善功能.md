# 基于仙工VDA5050协议手册完整支持

## 需要支持三种路径规划，Straight，CubicBeizer，INFPNURBS

### Straight

```json
{
    "orderId": "75982a12-7b9a-48a3-a8f7-efa1ee1cc465",
    "orderUpdateId": 0,
    "zoneSetId": "",
    "nodes": [
        {
            "nodeId": "LM1",
            "sequenceId": 0,
            "nodeDescription": "Device initial position",
            "released": true,
            "nodePosition": {
                "x": 14,
                "y": 12.3,
                "theta": 0,
                "allowedDeviationXY": 0.5,
                "allowedDeviationTheta": 0.5,
                "mapId": "01632ba1-5e0f-41b3-9d1c-b701fa168c3f",
                "mapDescription": "Id: 01632ba1-5e0f-41b3-9d1c-b701fa168c3f"
            },
            "actions": []
        },
        {
            "nodeId": "LM2",
            "sequenceId": 2,
            "nodeDescription": "Exitvector for PointOfInterest 04678a1e-3de5403f-bafc-e8badbee202a Dolly",
            "released": true,
            "nodePosition": {
                "x": 19,
                "y": 12.3,
                "theta": 0,
                "allowedDeviationXY": 0.7,
                "allowedDeviationTheta": 0,
                "mapId": "01632ba1-5e0f-41b3-9d1c-b701fa168c3f",
                "mapDescription": "Map Id 01632ba1-5e0f-41b3-9d1c-b701fa168c3f"
            },
            "actions": [
                {
                    "actionType": "pick",
                    "actionId": "20cd999e-6159-4d58-8a40-4d8fc08f3e1f",
                    "actionDescription": "pick",
                    "blockingType": "HARD",
                    "actionParameters": [
                        {
                            "key": "jack_height",
                            "value": 0.1
                        },
                        {
                            "key": "recognize",
                            "value": false
                        }
                    ]
                }
            ]
        }
    ],
    "edges": [
        {
            "edgeId": "LM1-LM2",
            "sequenceId": 1,
            "edgeDescription": "Edge connecting 7a434ec3-91c8-4334-89f831d30942fbb7 to 11119fc4-7fe4-4a91-b6be-210a065131da",
            "released": true,
            "startNodeId": "LM1",
            "endNodeId": "LM2",
            "maxSpeed": null,
            "maxHeight": null,
            "minHeight": null,
            "orientation": null,
            "direction": null,
            "rotationAllowed": false,
            "maxRotationSpeed": null,
            "trajectory": {
                "type": "Straight",
                "controlPoints": [
                    {
                        "x": 14,
                        "y": 12.3
                    },
                    {
                        "x": 19,
                        "y": 12.3
                    }
                ]
            },
            "length": null,
            "actions": []
        }
    ],
    "headerId": 0,
    "timeStamp": "11/15/2022 11:59:09",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

### CubicBeizer

```json
{
    "orderId": "75982a12-7b9a-48a3-a8f7-efa1ee1cc465",
    "orderUpdateId": 0,
    "zoneSetId": "",
    "nodes": [
        {
            "nodeId": "LM1",
            "sequenceId": 0,
            "nodeDescription": "Device initial position",
            "released": true,
            "nodePosition": {
                "x": 14,
                "y": 12.3,
                "theta": 0,
                "allowedDeviationXY": 0.5,
                "allowedDeviationTheta": 0.5,
                "mapId": "01632ba1-5e0f-41b3-9d1c-b701fa168c3f",
                "mapDescription": "Id: 01632ba1-5e0f-41b3-9d1c-b701fa168c3f"
            },
            "actions": []
        },
        {
            "nodeId": "LM2",
            "sequenceId": 2,
            "nodeDescription": "Exitvector for PointOfInterest 04678a1e-3de5403f-bafc-e8badbee202a Dolly",
            "released": true,
            "nodePosition": {
                "x": 19,
                "y": 12.3,
                "theta": 0,
                "allowedDeviationXY": 0.7,
                "allowedDeviationTheta": 0,
                "mapId": "01632ba1-5e0f-41b3-9d1c-b701fa168c3f",
                "mapDescription": "Map Id 01632ba1-5e0f-41b3-9d1c-b701fa168c3f"
            },
            "actions": [
                {
                    "actionType": "pick",
                    "actionId": "20cd999e-6159-4d58-8a40-4d8fc08f3e1f",
                    "actionDescription": "pick",
                    "blockingType": "HARD",
                    "actionParameters": [
                        {
                            "key": "jack_height",
                            "value": 0.1
                        },
                        {
                            "key": "recognize",
                            "value": false
                        }
                    ]
                }
            ]
        }
    ],
    "edges": [
        {
            "edgeId": "LM1-LM2",
            "sequenceId": 1,
            "edgeDescription": "Edge connecting 7a434ec3-91c8-4334-89f831d30942fbb7 to 11119fc4-7fe4-4a91-b6be-210a065131da",
            "released": true,
            "startNodeId": "LM1",
            "endNodeId": "LM2",
            "maxSpeed": null,
            "maxHeight": null,
            "minHeight": null,
            "orientation": null,
            "direction": null,
            "rotationAllowed": false,
            "maxRotationSpeed": null,
            "trajectory": {
                "controlPoints": [
                    {
                        "weight": 1,
                        "x": -0.034,
                        "y": 2.258
                    },
                    {
                        "weight": 1,
                        "x": 0.577,
                        "y": 2.258
                    },
                    {
                        "weight": 1,
                        "x": 0.841,
                        "y": 2.857
                    },
                    {
                        "weight": 1,
                        "x": 0.841,
                        "y": 3.791
                    }
                ],
                "degree": 3,
                "knotVector": [],
                "type": "CubicBezier"
            },
            "length": null,
            "actions": []
        }
    ],
    "headerId": 0,
    "timeStamp": "11/15/2022 11:59:09",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

### INFPNURBS

```json
{
    "orderId": "75982a12-7b9a-48a3-a8f7-efa1ee1cc465",
    "orderUpdateId": 0,
    "zoneSetId": "",
    "nodes": [
        {
            "nodeId": "LM1",
            "sequenceId": 0,
            "nodeDescription": "Device initial position",
            "released": true,
            "nodePosition": {
                "x": 14,
                "y": 12.3,
                "theta": 0,
                "allowedDeviationXY": 0.5,
                "allowedDeviationTheta": 0.5,
                "mapId": "01632ba1-5e0f-41b3-9d1c-b701fa168c3f",
                "mapDescription": "Id: 01632ba1-5e0f-41b3-9d1c-b701fa168c3f"
            },
            "actions": []
        },
        {
            "nodeId": "LM2",
            "sequenceId": 2,
            "nodeDescription": "Exitvector for PointOfInterest 04678a1e-3de5403f-bafc-e8badbee202a Dolly",
            "released": true,
            "nodePosition": {
                "x": 19,
                "y": 12.3,
                "theta": 0,
                "allowedDeviationXY": 0.7,
                "allowedDeviationTheta": 0,
                "mapId": "01632ba1-5e0f-41b3-9d1c-b701fa168c3f",
                "mapDescription": "Map Id 01632ba1-5e0f-41b3-9d1c-b701fa168c3f"
            },
            "actions": [
                {
                    "actionType": "pick",
                    "actionId": "20cd999e-6159-4d58-8a40-4d8fc08f3e1f",
                    "actionDescription": "pick",
                    "blockingType": "HARD",
                    "actionParameters": [
                        {
                            "key": "jack_height",
                            "value": 0.1
                        },
                        {
                            "key": "recognize",
                            "value": false
                        }
                    ]
                }
            ]
        }
    ],
    "edges": [
        {
            "edgeId": "LM1-LM2",
            "sequenceId": 1,
            "edgeDescription": "Edge connecting 7a434ec3-91c8-4334-89f831d30942fbb7 to 11119fc4-7fe4-4a91-b6be-210a065131da",
            "released": true,
            "startNodeId": "LM1",
            "endNodeId": "LM2",
            "maxSpeed": null,
            "maxHeight": null,
            "minHeight": null,
            "orientation": null,
            "direction": null,
            "rotationAllowed": false,
            "maxRotationSpeed": null,
            "trajectory": {
                "controlPoints": [
                    {
                        "weight": 1,
                        "x": -1,
                        "y": -4.358
                    },
                    {
                        "weight": 1,
                        "x": -2.5,
                        "y": -2.8
                    },
                    {
                        "weight": 1,
                        "x": -4,
                        "y": -0.75
                    },
                    {
                        "weight": 1,
                        "x": -5,
                        "y": 0.46
                    }
                ],
                "degree": 3,
                "knotVector": [],
                "type": "INFPNURBS"
            },
            "length": null,
            "actions": []
        }
    ],
    "headerId": 0,
    "timeStamp": "11/15/2022 11:59:09",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```



## 需要支持的instantActions类型

| actionType       | order | instantActions | 是否需要传参 | 备注                  |
| ---------------- | ----- | -------------- | ------------ | --------------------- |
| pick             | yes   | yes            | 是           | 顶升                  |
| drop             | yes   | yes            | 是           | 顶降                  |
| stopPause        | yes   | yes            | 否           | 暂停任务              |
| startPause       | yes   | yes            | 否           | 继续任务              |
| cancelOrder      |       | yes            | 否           | 取消任务              |
| factsheetRequest |       | yes            | 否           | 请求实例发布factsheet |
| startCharging    | yes   | yes            | 否           | 开始充电              |
| stopCharging     | yes   | yes            | 否           | 停止充电              |
| stateRequest     |       | yes            | 否           | State 上报请求        |
| Standard         | yes   | yes            | 是           | 自定义标准导航任务    |
| switchMap        | yes   | yes            | 是           | 切换地图              |
| rotateAgy        | yes   | yes            | 是           | 机器人旋转            |
| rotateLoad       | yes   | yes            | 是           | 旋转货物              |

- node的动作blockingType只能是HARD。

- 每⼀个edge只⽀持⼀个action，且action只⽀持机构脚本的动作和货叉升降动作。
- Action的动作，默认情况下执⾏的pick和drop。
- 如果是标准的⻋体动作，下发的action⽰例如下：如果edge包含动作，blockingType只要是NONE，则为异步动作，即：遍历edge时action任务即开始，遍历的edge任务和action任务都结束时，edge的任务结束。

#### 取消/暂停/继续任务

```json
{
    "actions": [
        {
            "actionType": "cancelOrder",
            "actionId": "01d47574-29aa-4dd7-bea2-5efcceea5f2d",
            "actionDescription": "Manual reset",
            "blockingType": "HARD",
            "actionParameters": []
        }
    ],
    "headerId": 218566232,
    "timeStamp": "2/6/2023 4:26:42 PM",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

#### 开环运动

```json
{
    "actions": [
        {
            "actionType": "motion",
            "actionId": "01d47574-29aa-4dd7-bea2-5efcceea5f2d",
            "actionDescription": "run a motion",
            "blockingType": "HARD",
            "actionParameters": [
                {
                    "key": "vx",
                    "value": 0.1
                },
                {
                    "key": "vy",
                    "value": 0
                },
                {
                    "key": "w",
                    "value": 0
                },
                {
                    "key": "duration",
                    "value": 50
                }
            ]
        }
    ],
    "headerId": 218566232,
    "timeStamp": "2/6/2023 4:26:42 PM",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

| 字段名     | 类型   | 描述                                                         | 可缺省 |
| ---------- | ------ | ------------------------------------------------------------ | ------ |
| VX         | number | 机器人在机器人坐标系中的 x 轴方向速度，若缺省则认为是 0，单位 m/s | 是     |
| VY         | number | 机器人在机器人坐标系中的 y 轴方向速度，若缺省则认为是 0，单位 m/s | 是     |
| W          | number | 机器人在机器人坐标系中的角速度（即顺时针转为负，逆时针转为正），若缺省则认为是 0，单位 rad/s | 是     |
| steer      | number | -2=一键回零，1=15°递增，-1=15°递减（机器人坐标系），仅当单舵轮机器人时该值有效，该字段存在时，不响应 vy 和 w，此时 vx 含义变为舵轮线速度 | 是     |
| real_steer | number | 目标舵角值（机器人坐标系），单位 rad，仅当单舵轮机器人时该值有效，该字段存在时，不响应 vy 和 w，此时 vx 含义变为舵轮线速度，优先级大于 steer | 是     |
| duration   | number | 机器人使用开环速度运动的持续时间，单位 ms, 0=一直保持当前开环速度运动，该参数缺省时，使用参数配置中 ControlMotionDuration 的数值 | 是     |

#### 平动

```json
{
    "actions": [
        {
            "actionType": "translate",
            "actionId": "01d47574-29aa-4dd7-bea2-5efcceea5f2d",
            "actionDescription": "run a translate",
            "blockingType": "HARD",
            "actionParameters": [
                {
                    "key": "vx",
                    "value": 0.1
                },
                {
                    "key": "vy",
                    "value": 0
                },
                {
                    "key": "dist",
                    "value": 0
                },
                {
                    "key": "mode",
                    "value": 1
                }
            ]
        }
    ],
    "headerId": 218566232,
    "timeStamp": "2/6/2023 4:26:42 PM",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

| 字段名 | 类型   | 描述                                                         | 可缺省 |
| ------ | ------ | ------------------------------------------------------------ | ------ |
| dist   | number | 直线运动距离，绝对值，单位：m                                | 否     |
| vx     | number | 机器人坐标系下 X 方向运动的速度，正为向前，负为向后，单位：m/s | 是     |
| vy     | number | 机器人坐标系下 Y 方向运动的速度，正为向左，负为向右，单位：m/s | 是     |
| mode   | number | 0 = 里程模式(根据里程进行运动)，1 = 定位模式，若缺省则默认为里程模式 | 是     |

#### 转动

```json
{
    "actions": [
        {
            "actionType": "turn",
            "actionId": "01d47574-29aa-4dd7-bea2-5efcceea5f2d",
            "actionDescription": "run a turn",
            "blockingType": "HARD",
            "actionParameters": [
                {
                    "key": "angle",
                    "value": 0.5
                },
                {
                    "key": "vw",
                    "value": 0
                },
                {
                    "key": "mode",
                    "value": 1
                }
            ]
        }
    ],
    "headerId": 218566232,
    "timeStamp": "2/6/2023 4:26:42 PM",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

| 字段名 | 类型   | 描述                                                         | 可缺省 |
| ------ | ------ | ------------------------------------------------------------ | ------ |
| angle  | number | 转动的角度(机器人坐标系), 绝对值, 单位 rad, 可以大于 \(2\pi\) | 否     |
| vw     | number | 转动的角速度(机器人坐标系), 正为逆时针转, 负为顺时针转 单位 rad/s | 否     |
| mode   | number | \(0 = \) 里程模式(根据里程进行运动), \(1 = \) 定位模式, 若缺省则默认为里程模式 | 是     |

#### 切换地图并重定位

切换地图需要传⼊新地图后的坐标（center_x，center_y，initiate_angle）。其中switchPoint和坐标⼆选⼀，⽤了switchPoint就不⽤坐标。

```json
{
    "actions": [
        {
            "actionType": "switchMap",
            "actionId": "01d47574-29aa-4dd7-bea20-5efcceea5f2d",
            "actionDescription": "Manual switchMap,switchPoint",
            "blockingType": "HARD",
            "actionParameters": [
                {
                    "key": "map",
                    "value": "duoc"
                },
                {
                    "key": "switchPoint",
                    "value": "LM3"
                },
                {
                    "key": "center_x",
                    "value": -16.280
                },
                {
                    "key": "center_y",
                    "value": -1.946
                },
                {
                    "key": "initiate_angle",
                    "value": 1.57
                }
            ]
        }
    ],
    "headerId": 218566232,
    "timeStamp": "2/6/2023 4:26:42 PM",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

如果使⽤地图的站点切换地图，可以只传站点：

```json
{
    "actions": [
        {
            "actionType": "switchMap",
            "actionId": "01d47574-29aa-4dd7-bea2-5efcceea5f2d",
            "actionDescription": "Manual switchMap",
            "blockingType": "HARD",
            "actionParameters": [
                {
                    "key": "mapId",
                    "value": "demo"
                },
                {
                    "key": "switchPoint",
                    "value": "map"
                }
            ]
        }
    ],
    "headerId": 218566232,
    "timeStamp": "2/6/2023 4:26:42 PM",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

#### 初始化坐标

使用此动作，机器⼈会导航到指定的坐标。

```json
{
    "actions": [
        {
            "actionType": "initPosition",
            "actionId": "3261fe5f-5c91-451d-b2be-339dc46e2ffe",
            "actionDescription": "Initializing position of 427d1a10-75e6-41aaaab7-f553990f5ad9 from X: 10.904905 Y: 11.442172 Theta: -3.1415925 to POI ",
            "blockingType": "HARD",
            "actionParameters": [
                {
                    "key": "x",
                    "value": -15.548
                },
                {
                    "key": "y",
                    "value": 4.8
                },
                {
                    "key": "theta",
                    "value": 0
                },
                {
                    "key": "coordinate",
                    "value": "world"
                },
                {
                    "key": "reachAngle",
                    "value": 0.1
                },
                {
                    "key": "reachDist",
                    "value": 0.02
                },
                {
                    "key": "useOdo",
                    "value": 1
                },
                {
                    "key": "maxSpeed",
                    "value": 1.0
                },
                {
                    "key": "maxRot",
                    "value": 1.0
                },
                {
                    "key": "hold_dir",
                    "value": 999
                }
            ]
        }
    ],
    "headerId": 66523429,
    "timeStamp": "2/6/2023 4:25:57 PM",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

#### 旋转货物

```json
{
    "actions": [
        {
            "actionType": "rotateLoad",
            "actionId": "rotateLoad",
            "actionDescription": "rotateLoad",
            "blockingType": "HARD",
            "actionParameters": [
                {
                    "key": "angle",
                    "value": -1.57
                }
            ]
        }
    ],
    "headerId": 218566232,
    "timeStamp": "2/6/2023 4:26:42 PM",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

#### 清除错误

```json
{
    "actions": [
        {
            "actionType": "clearErrors",
            "actionId": "clearErrors-1",
            "actionDescription": "run a clearErrors",
            "blockingType": "HARD",
            "actionParameters": []
        }
    ],
    "headerId": 218566232,
    "timeStamp": "2/6/2023 4:26:42 PM",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

#### 旋转车体

```json
{
    "actions": [
        {
            "actionType": "rotateAgv",
            "actionId": "rotateLoad",
            "actionDescription": "rotateAgv",
            "blockingType": "HARD",
            "actionParameters": [
                {
                    "key": "angle",
                    "value": -1.57
                }
            ]
        }
    ],
    "headerId": 2,
    "timeStamp": "2/6/2023 4:26:42 PM",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

### 不同车型对应的Operation不同

| 车体类型      | Operation   | actionType |
| ------------- | ----------- | ---------- |
| Fork/FORKLIFT | ForkLoad    | Pick       |
|               | Fork Unload | Drop       |
| Jack/CARRIER  | JackLoad    | Pick       |
|               | JackUnload  | Drop       |
| 无定义/NONE   | Script      | Script     |

### 取货order中的actions字段下内容

```json
{
    "actionType": "pick",
    "actionId": "20cd999e-6159-4d58-8a40-4d8fc08f3e1f",
    "actionDescription": "pick",
    "blockingType": "HARD",
    "actionParameters": [
        {
            "key": "recfile",
            "value": "pallet/p0001.pallet"
        },
        {
            "key": "start_height",
            "value": 0.4
        },
        {
            "key": "rec_height",
            "value": 1
        },
        {
            "key": "end_height",
            "value": 1
        },
        {
            "key": "recognize",
            "value": true
        }
    ]
}
```

### 放货order中的actions字段下内容

```json
{
    "actionType": "dock",
    "actionId": "20cd999e-6159-4d58-8a40-4d8fc08f3e1f",
    "actionDescription": "pick",
    "blockingType": "HARD",
    "actionParameters": [
        {
            "key": "recfile",
            "value": "pallet/p0001.pallet"
        },
        {
            "key": "start_height",
            "value": 0.4
        },
        {
            "key": "rec_height",
            "value": 1
        },
        {
            "key": "end_height",
            "value": 1
        },
        {
            "key": "recognize",
            "value": true
        }
    ]
}
```

### 纯路径导航（不含nodePosition和trajectory）

```json
{
    "headerId": 0,
    "timestamp": "2023-11-24T14:45:04.478Z",
    "version": "2.0.0",
    "manufacturer": "",
    "serialNumber": "",
    "orderId": "424d8aa0-93e4-4e2d-a19d-1f06a6150010",
    "orderUpdateId": 0,
    "nodes": [
        {
            "nodeId": "AP1",
            "sequenceId": 0,
            "released": true,
            "actions": [],
            "nodeDescription": ""
        },
        {
            "nodeId": "LM9",
            "sequenceId": 2,
            "released": true,
            "actions": [],
            "nodeDescription": ""
        }
    ],
    "edges": [
        {
            "edgeId": "AP1-LM9",
            "sequenceId": 1,
            "edgeDescription": "",
            "released": true,
            "startNodeId": "AP1",
            "endNodeId": "LM9",
            "maxSpeed": 0.0,
            "maxHeight": 0.0,
            "orientation": 0.0,
            "direction": "",
            "rotationAllowed": false,
            "maxRotationSpeed": 0.0,
            "trajectory": null,
            "length": 0.0,
            "actions": []
        }
    ]
}
```

需要支持node和edges字段下的所有可选参数，需要其能解析，能识别，能生效。

### 路径导航带动作（含nodePosition，不含trajectory）

当 order 中 node 包含 nodePosition，而 edge 不包含 trajectory（为空）时，则认为 node 的位置信息来自于已有地图（nodeId 为地图站点名称），即 nodePosition 的 [x,y] 这个点（站点）对应的坐标必须存在地图中，行走的轨迹按照地图路径行驶。

如果 node 的位置信息不存在地图中，则认为 edge 是直线（原地到目标点），下发的任务是直线任务。如果要曲线，则在 trajectory 中指定。

下述示例为导航到 LM58 点，LM58 在地图上的坐标为（3.83，-1.12），但在 nodePosition 中设置为 LM58（3.43，-1.12），则最终停止位置为（3.43，-1.12）。

```json
{
    "version": "2.0.0",
    "manufacturer": "59-58",
    "timestamp": "2024-08-28T15:06:15.979142+08:00",
    "headerId": 227,
    "serialNumber": "",
    "orderId": "1253-20240828T150649",
    "orderUpdateId": 0,
    "zoneSetId": "",
    "nodes": [
        {
            "nodeId": "LM59",
            "sequenceId": 1,
            "nodeDescription": "",
            "released": true,
            "nodePosition": {
                "x": 5.63,
                "y": -1.12,
                "theta": 0.0,
                "allowedDeviationXY": 0.01,
                "allowedDeviationTheta": 0.01,
                "mapId": "QX1",
                "mapDescription": ""
            },
            "actions": []
        },
        {
            "nodeId": "LM58",
            "sequenceId": 3,
            "nodeDescription": "",
            "released": true,
            "nodePosition": {
                "x": 3.43,
                "y": -1.12,
                "theta": 0.0,
                "allowedDeviationXY": 0.01,
                "allowedDeviationTheta": 0.1,
                "mapId": "QX1",
                "mapDescription": ""
            },
            "actions": []
        }
    ],
    "edges": [
        {
            "edgeId": "LM59-LM58",
            "sequenceId": 2,
            "edgeDescription": "",
            "released": true,
            "startNodeId": "LM59",
            "endNodeId": "LM58",
            "maxSpeed": 0.8,
            "maxHeight": 2.0,
            "minHeight": 0.0,
            "orientation": 0,
            "orientationType": "TANGENTIAL",
            "direction": "FORWARD",
            "rotationAllowed": true,
            "maxRotationSpeed": 1.0,
            "length": 1.9,
            "actions": []
        }
    ]
}
```

### 坐标导航（含nodePosition和trajectory）

当order包含nodePosition，⽽edge也含trajectory时，则按照order定义的坐标轨迹⾏驶

```json
{
    "orderId": "75982a12-7b9a-48a3-a8f7-efa1ee1cc465",
    "orderUpdateId": 0,
    "zoneSetId": "",
    "nodes": [
        {
            "nodeId": "7a434ec3-91c8-4334-89f8-31d30942fbb7",
            "sequenceId": 0,
            "nodeDescription": "Device initial position",
            "released": true,
            "nodePosition": {
                "x": 14.0,
                "y": 12.3,
                "theta": 0.0,
                "allowedDeviationXY": 0.5,
                "allowedDeviationTheta": 0.5,
                "mapId": "01632ba1-5e0f-41b3-9d1c-b701fa168c3f",
                "mapDescription": "Id: 01632ba1-5e0f-41b3-9d1c-b701fa168c3f"
            },
            "actions": []
        },
        {
            "nodeId": "11119fc4-7fe4-4a91-b6be-210a065131da",
            "sequenceId": 2,
            "nodeDescription": "Exitvector for PointOfInterest 04678a1e-3de5403f-bafc-e8badbee202a Dolly",
            "released": true,
            "nodePosition": {
                "x": 19.0,
                "y": 12.3,
                "theta": 0.0,
                "allowedDeviationXY": 0.7,
                "allowedDeviationTheta": 0.0,
                "mapId": "01632ba1-5e0f-41b3-9d1c-b701fa168c3f",
                "mapDescription": "Map Id 01632ba1-5e0f-41b3-9d1cb701fa168c3f"
            },
            "actions": []
        }
    ],
    "edges": [
        {
            "edgeId": "758de28a-c7f6-4475-b623-c4c895780b26",
            "sequenceId": 1,
            "edgeDescription": "Edge connecting ",
            "released": true,
            "startNodeId": "7a434ec3-91c8-4334-89f8-31d30942fbb7",
            "endNodeId": "11119fc4-7fe4-4a91-b6be-210a065131da",
            "maxSpeed": null,
            "maxHeight": null,
            "minHeight": null,
            "orientation": null,
            "direction": null,
            "rotationAllowed": false,
            "maxRotationSpeed": null,
            "trajectory": {
                "type": "Straight",
                "controlPoints": [
                    {
                        "x": 14.0,
                        "y": 12.3
                    },
                    {
                        "x": 19.0,
                        "y": 12.3
                    }
                ]
            },
            "length": null,
            "actions": []
        }
    ],
    "headerId": 0,
    "timeStamp": "11/15/2022 11:59:09",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

### 坐标导航带动作（含nodePosition和trajectory）

当order包含nodePosition，⽽edge也含trajectory时，则按照order定义的坐标轨迹⾏驶。其中附加的动作和路径导航保持⼀致，仅是导航⽅式区别。

```json
{
    "orderId": "75982a12-7b9a-48a3-a8f7-efa1ee1cc465",
    "orderUpdateId": 0,
    "zoneSetId": "",
    "nodes": [
        {
            "nodeId": "7a434ec3-91c8-4334-89f8-31d30942fbb7",
            "sequenceId": 0,
            "nodeDescription": "Device initial position",
            "released": true,
            "nodePosition": {
                "x": 14.0,
                "y": 12.3,
                "theta": 0.0,
                "allowedDeviationXY": 0.5,
                "allowedDeviationTheta": 0.5,
                "mapId": "01632ba1-5e0f-41b3-9d1c-b701fa168c3f",
                "mapDescription": "Id: 01632ba1-5e0f-41b3-9d1c-b701fa168c3f"
            },
            "actions": []
        },
        {
            "nodeId": "11119fc4-7fe4-4a91-b6be-210a065131da",
            "sequenceId": 2,
            "nodeDescription": "Exitvector for PointOfInterest 04678a1e-3de5403f-bafc-e8badbee202a Dolly",
            "released": true,
            "nodePosition": {
                "x": 19.0,
                "y": 12.3,
                "theta": 0.0,
                "allowedDeviationXY": 0.7,
                "allowedDeviationTheta": 0.0,
                "mapId": "01632ba1-5e0f-41b3-9d1c-b701fa168c3f",
                "mapDescription": "Map Id 01632ba1-5e0f-41b3-9d1cb701fa168c3f"
            },
            "actions": [
                {
                    "actionType": "pick",
                    "actionId": "20cd999e-6159-4d58-8a40-4d8fc08f3e1f",
                    "actionDescription": "pick",
                    "blockingType": "HARD",
                    "actionParameters": [
                        {
                            "key": "jack_height",
                            "value": 0.1
                        },
                        {
                            "key": "recognize",
                            "value": false
                        },
                        {
                            "key": "recfile",
                            "value": "pallet/p0001.pallet"
                        }
                    ]
                }
            ]
        }
    ],
    "edges": [
        {
            "edgeId": "758de28a-c7f6-4475-b623-c4c895780b26",
            "sequenceId": 1,
            "edgeDescription": "Edge connecting ",
            "released": true,
            "startNodeId": "7a434ec3-91c8-4334-89f8-31d30942fbb7",
            "endNodeId": "11119fc4-7fe4-4a91-b6be-210a065131da",
            "maxSpeed": null,
            "maxHeight": null,
            "minHeight": null,
            "orientation": null,
            "direction": null,
            "rotationAllowed": false,
            "maxRotationSpeed": null,
            "trajectory": {
                "type": "Straight",
                "controlPoints": [
                    {
                        "x": 14.0,
                        "y": 12.3
                    },
                    {
                        "x": 19.0,
                        "y": 12.3
                    }
                ]
            },
            "length": null,
            "actions": []
        }
    ],
    "headerId": 0,
    "timeStamp": "11/15/2022 11:59:09",
    "version": "v1",
    "manufacturer": "",
    "serialNumber": ""
}
```

### 多个node路径导航带动作（不含nodePosition和trajectory）

本命令实现从LM9⸺AP1放货⸺LM9⸺AP1这样重复路径导航，其他多点node也可参考此⽤例。如 果此时⻋在LM9点，则完整执⾏；若此时在其他点，则直接执⾏：当前点⸺AP1放货⸺LM9⸺ AP1。

```json
{
    "version": "2.0.0",
    "manufacturer": "RobotY",
    "timestamp": "2024-08-28T15:06:15.979142+08:00",
    "headerId": 227,
    "serialNumber": "AMB-09",
    "orderId": "1252-20240917T150617",
    "orderUpdateId": 0,
    "zoneSetId": "",
    "nodes": [
        {
            "nodeId": "LM9",
            "sequenceId": 1,
            "nodeDescription": "",
            "released": true,
            "actions": []
        },
        {
            "nodeId": "AP1",
            "sequenceId": 3,
            "nodeDescription": "",
            "released": true,
            "actions": [
                {
                    "actionDescription": "PICK",
                    "actionId": "486",
                    "actionParameters": [
                        {
                            "key": "start_height",
                            "value": 1.83
                        },
                        {
                            "key": "end_height",
                            "value": 0
                        }
                    ],
                    "actionType": "drop",
                    "blockingType": "HARD"
                }
            ]
        },
        {
            "nodeId": "LM9",
            "sequenceId": 5,
            "nodeDescription": "",
            "released": true,
            "actions": []
        },
        {
            "nodeId": "AP1",
            "sequenceId": 7,
            "nodeDescription": "",
            "released": true,
            "actions": []
        }
    ],
    "edges": [
        {
            "edgeId": "LM9-AP1",
            "sequenceId": 2,
            "edgeDescription": "",
            "released": true,
            "startNodeId": "LM9",
            "endNodeId": "AP1",
            "maxSpeed": 0.8,
            "maxHeight": 2.0,
            "minHeight": 0.0,
            "orientation": 0,
            "orientationType": "TANGENTIAL",
            "direction": "FORWARD",
            "rotationAllowed": true,
            "maxRotationSpeed": 1.0,
            "length": 1.9,
            "actions": []
        },
        {
            "edgeId": "AP1-LM9",
            "sequenceId": 4,
            "edgeDescription": "",
            "released": true,
            "startNodeId": "AP1",
            "endNodeId": "LM9",
            "maxSpeed": 0.8,
            "maxHeight": 2.0,
            "minHeight": 0.0,
            "orientation": 0,
            "orientationType": "TANGENTIAL",
            "direction": "FORWARD",
            "rotationAllowed": true,
            "maxRotationSpeed": 1.0,
            "length": 1.9,
            "actions": []
        },
        {
            "edgeId": "LM9-AP1",
            "sequenceId": 6,
            "edgeDescription": "",
            "released": true,
            "startNodeId": "LM9",
            "endNodeId": "AP1",
            "maxSpeed": 0.8,
            "maxHeight": 2.0,
            "minHeight": 0.0,
            "orientation": 0,
            "orientationType": "TANGENTIAL",
            "direction": "FORWARD",
            "rotationAllowed": true,
            "maxRotationSpeed": 1.0,
            "length": 1.9,
            "actions": []
        }
    ]
}
```

### 只有⼀个node（含nodePosition）

特殊情况，order只包含⼀个node节点，同时node包含actions。动作不限制数量，机器⼈会原地顺序执⾏所有动作。

```json
{
    "headerId": 0,
    "timestamp": "2023-11-24T14:45:04.478Z",
    "version": "2.0.0",
    "manufacturer": "",
    "serialNumber": "",
    "orderId": "424d8aa0-93e4-4e2d-a19d-1f06a6150010",
    "orderUpdateId": 0,
    "nodes": [
        {
            "nodeId": "LM2",
            "sequenceId": 2,
            "released": true,
            "actions": [
                {
                    "actionType": "pick",
                    "actionId": "20cd999e-6159-4d58-8a40-4d8fc08f3e1f",
                    "actionDescription": "pick",
                    "blockingType": "HARD",
                    "actionParameters": []
                }
            ],
            "nodeDescription": ""
        }
    ],
    "edges": []
}
```

## 关于topic：factsheet的说明

```json
{
    "headerId": 81,
    "timestamp": "2024-04-22T17:36:54.168Z",
    "version": "v3.4.6.15",
    "manufacturer": "SEER",
    "serialNumber": "AMB-01",
    "typeSpecification": {
        "seriesName": "AMB-01",
        "seriesDescription": "AMB-01",
        "agvKinematic": "STEER",
        "agvClass": "FORKLIFT",
        "maxLoadMass": 0.5,
        "localizationTypes": [
            "SLAM"
        ],
        "navigationTypes": [
            "VIRTUAL_LINE_GUIDED"
        ]
    },
    "physicalParameters": {
        "speedMin": 0.01,
        "speedMax": 1,
        "accelerationMax": 0.5,
        "decelerationMax": 0.5,
        "heightMin": 2.234,
        "heightMax": 2.234,
        "width": 0.951,
        "length": 1.72169
    },
    "protocolLimits": null,
    "protocolFeatures": null,
    "agvGeometry": null,
    "loadSpecification": null,
    "localizationParameters": null
}
```

## 关于topic：connection的说明

上线，周期推送，可在配置⽂件配置推送频率 

```json
{
    "headerId": 8,
    "timestamp": "2024-04-22T17:37:20.783Z",
    "version": "2.0.0",
    "manufacturer": "seer",
    "serialNumber": "AMB-01",
    "connectionState": "ONLINE"
}
```

 遗嘱信息

```json
{
    "connectionState": "CONNECTIONBROKEN",
    "headerId": 999999999,
    "manufacturer": "SEER",
    "serialNumber": "AMB-01",
    "timestamp": "2024-04-22T17:36:21.745Z",
    "version": "v3.4.6.15"
}
```

## 关于topic：visualization 的说明

周期推送，可在配置⽂件配置推送频率

```json
{
    "headerId": 8,
    "timestamp": "2024-04-22T17:37:20.783Z",
    "version": "2.0.0",
    "manufacturer": "",
    "serialNumber": "AMB-01",
    "agvPosition": {
        "x": 6.4616,
        "y": 2.6107,
        "theta": -1.5765,
        "mapId": "1",
        "positionInitialized": true,
        "mapDescription": "",
        "localizationScore": 0.9942,
        "deviationRange": 0
    },
    "velocity": {
        "vx": 0,
        "vy": 0,
        "omega": 0
    }
}
```



# 碰撞检测

**核心任务：开发实时防撞逻辑**

- **输入接口：** 能够持续接收所有仿真车的实时坐标、物理参数、顶升状态信号。
- **轮廓计算模型：**
  - 实现根据小车`physicalParameters`计算其基础二维矩形/多边形范围的算法。
  - 实现顶升状态下，基础轮廓与托盘轮廓的**外包络矩形**计算逻辑。
- **安全范围模型：**
  - 实现一个可配置的**安全系数**或**安全距离**参数。
  - 实现将仿真实体范围按规则放大的算法。
- **碰撞检测服务：**
  - 实现一个高性能的二维几何重叠检测算法，能循环检测所有小车对。
  - 设定检测周期（如：每100ms检测一次）。
- **控制与告警输出：**
  - 实现紧急停止指令的下发接口。
  - 实现结构化碰撞错误信息的生成与推送接口。



# 主动错误注入

需要主动为小车注入错误，可选错误列表如下

1. 导航任务进行中时，MQTT掉线
2. 导航任务进行中时，发送cancelorder，模拟任务中断
3. 导航任务进行中时，对仿真车坐标随机抖动，模拟定位异常
4. 随机初始化到地图的随机坐标，模拟定位丢失
5. 充电时，将充电标志置为false，模拟充电失败
6. 托盘角度大角度抖动，模拟顶升状态异常
7. 地图中随机位置添加障碍物